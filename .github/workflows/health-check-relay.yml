name: US-Based Health Check Relay

on:
  schedule:
    # Run every 5 minutes (matching Cloudflare cron)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  health-check:
    runs-on: ubuntu-latest  # Runs in US-based Azure datacenter
    timeout-minutes: 5

    steps:
      - name: Check Manage
        id: manage
        continue-on-error: true
        run: |
          START_TIME=$(date +%s%3N)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            --user-agent "MSP-Dashboard-Monitor/1.0-GH" \
            "https://sscw.stratixsystems.com/")
          END_TIME=$(date +%s%3N)
          RESPONSE_TIME=$((END_TIME - START_TIME))

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

      - name: Check Automate
        id: automate
        continue-on-error: true
        run: |
          START_TIME=$(date +%s%3N)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            --user-agent "MSP-Dashboard-Monitor/1.0-GH" \
            "https://automate.stratixsystems.com/automate/")
          END_TIME=$(date +%s%3N)
          RESPONSE_TIME=$((END_TIME - START_TIME))

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

      - name: Check ScreenConnect
        id: screenconnect
        continue-on-error: true
        run: |
          START_TIME=$(date +%s%3N)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            --user-agent "MSP-Dashboard-Monitor/1.0-GH" \
            "https://help.stratixsystems.com/")
          END_TIME=$(date +%s%3N)
          RESPONSE_TIME=$((END_TIME - START_TIME))

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

      - name: Build JSON Payload
        id: payload
        env:
          MANAGE_CODE: ${{ steps.manage.outputs.http_code }}
          MANAGE_TIME: ${{ steps.manage.outputs.response_time || 0 }}
          AUTOMATE_CODE: ${{ steps.automate.outputs.http_code }}
          AUTOMATE_TIME: ${{ steps.automate.outputs.response_time || 0 }}
          SCREENCONNECT_CODE: ${{ steps.screenconnect.outputs.http_code }}
          SCREENCONNECT_TIME: ${{ steps.screenconnect.outputs.response_time || 0 }}
        run: |
          # Create JSON payload with all results (compact, no whitespace)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > payload.json <<EOF
{"checks":[{"service_id":1,"service_name":"Manage","http_code":"${MANAGE_CODE}","response_time":${MANAGE_TIME},"timestamp":"${TIMESTAMP}"},{"service_id":2,"service_name":"Automate","http_code":"${AUTOMATE_CODE}","response_time":${AUTOMATE_TIME},"timestamp":"${TIMESTAMP}"},{"service_id":3,"service_name":"ScreenConnect","http_code":"${SCREENCONNECT_CODE}","response_time":${SCREENCONNECT_TIME},"timestamp":"${TIMESTAMP}"}]}
EOF

          echo "Generated payload:"
          cat payload.json

      - name: Send to Cloudflare Worker
        env:
          WORKER_URL: ${{ secrets.WORKER_HEALTH_RELAY_URL }}
          RELAY_SECRET: ${{ secrets.HEALTH_RELAY_SECRET }}
        run: |
          # Generate HMAC signature for authentication (sign the exact file bytes)
          SIGNATURE=$(openssl dgst -sha256 -hmac "$RELAY_SECRET" < payload.json | sed 's/^.* //')

          curl -X POST "$WORKER_URL/api/health-relay" \
            -H "Content-Type: application/json" \
            -H "X-Relay-Signature: sha256=$SIGNATURE" \
            -H "User-Agent: GitHub-Actions-Health-Relay/1.0" \
            --data @payload.json \
            --max-time 10 \
            --fail-with-body
